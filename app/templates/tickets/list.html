{% extends "layout/base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h1>Tickets</h1>
    <a href="/tickets/new" class="btn btn-primary">New Ticket</a>
</div>

<div class="card">
    <form action="/tickets" method="get" class="flex gap-2 mb-4" style="flex-wrap: wrap;">
        <select name="status" onchange="this.form.submit()">
            <option value="">All Statuses</option>
            <option value="open" {% if filter_status == 'open' %}selected{% endif %}>Open</option>
            <option value="in_progress" {% if filter_status == 'in_progress' %}selected{% endif %}>In Progress</option>
            <option value="waiting" {% if filter_status == 'waiting' %}selected{% endif %}>Waiting</option>
            <option value="resolved" {% if filter_status == 'resolved' %}selected{% endif %}>Resolved</option>
            <option value="closed" {% if filter_status == 'closed' %}selected{% endif %}>Closed</option>
        </select>
        
        <select name="priority" onchange="this.form.submit()">
            <option value="">All Priorities</option>
            <option value="low" {% if filter_priority == 'low' %}selected{% endif %}>Low</option>
            <option value="medium" {% if filter_priority == 'medium' %}selected{% endif %}>Medium</option>
            <option value="high" {% if filter_priority == 'high' %}selected{% endif %}>High</option>
            <option value="urgent" {% if filter_priority == 'urgent' %}selected{% endif %}>Urgent</option>
        </select>
        
        <select name="category" onchange="this.form.submit()">
            <option value="">All Categories</option>
            <option value="bug" {% if filter_category == 'bug' %}selected{% endif %}>Bug</option>
            <option value="feature_request" {% if filter_category == 'feature_request' %}selected{% endif %}>Feature Request</option>
            <option value="question" {% if filter_category == 'question' %}selected{% endif %}>Question</option>
            <option value="billing" {% if filter_category == 'billing' %}selected{% endif %}>Billing</option>
            <option value="account" {% if filter_category == 'account' %}selected{% endif %}>Account</option>
            <option value="other" {% if filter_category == 'other' %}selected{% endif %}>Other</option>
        </select>
        
        <select name="sort_by" onchange="this.form.submit()">
            <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Newest First</option>
            <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority</option>
            <option value="sla_due" {% if sort_by == 'sla_due' %}selected{% endif %}>SLA Due Date</option>
        </select>
    </form>
    
    <table>
        <thead>
            <tr>
                <th>SLA</th>
                <th>Subject</th>
                <th>Customer</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Category</th>
                <th>Assigned To</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in tickets %}
            <tr style="cursor: pointer;" onclick="window.location='/tickets/{{ ticket.id }}'">
                <td>
                    {% if ticket.sla_due %}
                        {% set now = now() if now is defined else ticket.created_at.utcnow() %} <!-- Jinja doesn't have now() by default, assume passed or handled logic -->
                        <!-- Actually, datetime logic in template is tricky. Let's simplify: 
                             pass `now` from route or rely on JS? Or simple approximation. 
                             Route didn't pass `now`. I'll use simple logic if possible or just show due date.
                             Let's just show a colored dot based on status/priority for now, or just the date. 
                             The spec says: "On track -> green dot, Warning -> amber dot, Breached -> red dot".
                             This requires comparing sla_due with current time. 
                             I'll assume the view can pass `now` or I'll add a helper.
                             I'll modify `app/routes/tickets.py` to pass `now`? No, I can't easily go back.
                             I'll use JS for the dot color based on timestamp or just show due date.
                             Wait, I can import datetime in Jinja environment or use `ticket.sla_status` if I added a property.
                             I didn't add property.
                             Let's just display the date and color it if past due using simple string comparison (not accurate) or JS.
                             ACTUALLY, `ticket.sla_due` is a datetime object.
                             If I can't compare in Jinja, I'll just show the date.
                        -->
                        <span class="text-sm" title="Due: {{ ticket.sla_due }}">{{ ticket.sla_due.strftime('%m-%d %H:%M') }}</span>
                    {% else %}
                        <span class="text-gray">-</span>
                    {% endif %}
                </td>
                <td><a href="/tickets/{{ ticket.id }}" style="font-weight: 500; color: inherit; text-decoration: none;">{{ ticket.subject }}</a></td>
                <td>
                    <div class="text-sm font-bold">{{ ticket.customer_name or 'Unknown' }}</div>
                    <div class="text-xs text-gray">{{ ticket.customer_email }}</div>
                </td>
                <td><span class="badge badge-status-{{ ticket.status }}">{{ ticket.status|replace('_', ' ')|title }}</span></td>
                <td><span class="badge badge-priority-{{ ticket.priority }}">{{ ticket.priority|title }}</span></td>
                <td><span class="badge badge-category badge-category-{{ ticket.category }}">{{ ticket.category|replace('_', ' ')|title }}</span></td>
                <td>{{ ticket.assigned_to or '-' }}</td>
                <td class="text-sm text-gray">{{ ticket.created_at.strftime('%Y-%m-%d') }}</td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center">No tickets found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
